{% extends "base.html" %}

{% block title %}SkyGuard Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Content -->
<div id="dashboard-section" class="section">
    <!-- Statistics Cards removed per request -->
    
    <!-- Recent Detections -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-eye"></i> Recent Detections
                    </h5>
                </div>
                <div class="card-body">
                    <div id="recent-detections">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Detection Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="detection-chart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Information -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> System Information
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td><strong>Uptime:</strong></td>
                                <td id="system-uptime">Loading...</td>
                            </tr>
                            <tr>
                                <td><strong>Last Detection:</strong></td>
                                <td id="last-detection">None</td>
                            </tr>
                            <tr>
                                <td><strong>AI Confidence:</strong></td>
                                <td id="ai-confidence">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i> Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-skyguard" onclick="testCamera()">
                            <i class="fas fa-video"></i> Test Camera
                        </button>
                        <button class="btn btn-skyguard" onclick="testAI()">
                            <i class="fas fa-brain"></i> Test AI Model
                        </button>
                        <button class="btn btn-skyguard" onclick="testAlerts()">
                            <i class="fas fa-bell"></i> Test Alerts
                        </button>
                        <button class="btn btn-outline-primary" onclick="showSection('configuration')">
                            <i class="fas fa-cog"></i> Configure System
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Recent Captures Section -->
    <div id="recent-captures-section" class="section" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-camera"></i> Recent Captures
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="camera-container">
                            <img id="recent-capture-image" src="/api/camera/feed" alt="Recent Capture" class="img-fluid rounded">
                            <div class="camera-timestamp">
                                <span id="capture-timestamp">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="camera-controls">
                            <h6>Capture Controls</h6>
                            <div class="mb-3">
                                <p class="text-muted">This shows the most recent image captured by the camera system.</p>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-skyguard" onclick="refreshRecentCapture()">
                                    <i class="fas fa-sync"></i> Refresh Image
                                </button>
                                <button class="btn btn-outline-primary" onclick="downloadRecentCapture()">
                                    <i class="fas fa-download"></i> Download Image
                                </button>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Images are automatically updated every 3 seconds when the main system is running.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Detections Section -->
<div id="detections-section" class="section" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-eye"></i> All Detections
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="detection-search" placeholder="Search detections...">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-filter"></i>
                        </span>
                        <select class="form-select" id="detection-filter">
                            <option value="all">All Detections</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="detections-list">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Section -->
<div id="configuration-section" class="section" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-cog"></i> System Configuration
            </h5>
        </div>
        <div class="card-body">
            <form id="config-form">
                <!-- System Configuration -->
                <div class="config-section">
                    <h5>System Settings</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="detection-interval" class="form-label">Detection Interval (seconds)</label>
                            <input type="number" class="form-control" id="detection-interval" min="0.1" max="10" step="0.1">
                        </div>
                        <div class="col-md-6">
                            <label for="max-history" class="form-label">Max Detection History</label>
                            <input type="number" class="form-control" id="max-history" min="100" max="10000">
                        </div>
                    </div>
                </div>
                
                <!-- Camera Configuration -->
                <div class="config-section">
                    <h5>Camera Settings</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="camera-source" class="form-label">Camera Source</label>
                            <select class="form-select" id="camera-source">
                                <option value="0">Camera 0 (Default)</option>
                                <option value="1">Camera 1</option>
                                <option value="2">Camera 2</option>
                                <option value="3">Camera 3</option>
                                <option value="4">Camera 4</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="camera-width" class="form-label">Width</label>
                            <input type="number" class="form-control" id="camera-width" min="320" max="1920">
                        </div>
                        <div class="col-md-3">
                            <label for="camera-height" class="form-label">Height</label>
                            <input type="number" class="form-control" id="camera-height" min="240" max="1080">
                        </div>
                        <div class="col-md-3">
                            <label for="camera-fps" class="form-label">FPS</label>
                            <input type="number" class="form-control" id="camera-fps" min="1" max="60">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="camera-rotation" class="form-label">Rotation</label>
                            <select class="form-select" id="camera-rotation">
                                <option value="0">0¬∞</option>
                                <option value="90">90¬∞</option>
                                <option value="180">180¬∞</option>
                                <option value="270">270¬∞</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="camera-flip-horizontal">
                                <label class="form-check-label" for="camera-flip-horizontal">
                                    Flip Horizontal
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="camera-flip-vertical">
                                <label class="form-check-label" for="camera-flip-vertical">
                                    Flip Vertical
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="camera-brightness" class="form-label">Brightness</label>
                            <input type="range" class="form-range" id="camera-brightness" min="-100" max="100" value="0">
                            <div class="form-text">Current value: <span id="brightness-value">0</span></div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="camera-contrast" class="form-label">Contrast</label>
                            <input type="range" class="form-range" id="camera-contrast" min="-100" max="100" value="0">
                            <div class="form-text">Current value: <span id="contrast-value">0</span></div>
                        </div>
                        <div class="col-md-9">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="camera-live-view">
                                <label class="form-check-label" for="camera-live-view">
                                    Enable Live Camera View
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Configuration -->
                <div class="config-section">
                    <h5>AI Model Settings</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="confidence-threshold" class="form-label">Confidence Threshold</label>
                            <input type="range" class="form-range" id="confidence-threshold" min="0" max="1" step="0.01">
                            <div class="form-text">Current value: <span id="confidence-value">0.5</span></div>
                        </div>
                        <div class="col-md-6">
                            <label for="nms-threshold" class="form-label">NMS Threshold</label>
                            <input type="range" class="form-range" id="nms-threshold" min="0" max="1" step="0.01">
                            <div class="form-text">Current value: <span id="nms-value">0.4</span></div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="detection-log-level" class="form-label">Detection Log Level</label>
                            <select class="form-select" id="detection-log-level">
                                <option value="minimal">Minimal - No detection logging</option>
                                <option value="standard">Standard - Log detections and species (default)</option>
                                <option value="detailed">Detailed - Include all candidate species</option>
                            </select>
                            <div class="form-text">Controls the level of detail in detection logs</div>
                        </div>
                    </div>
                </div>
                
                <!-- Notifications Configuration -->
                <div class="config-section">
                    <h5>Notification Settings</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="audio-enabled">
                                <label class="form-check-label" for="audio-enabled">
                                    Audio Alerts
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sms-enabled">
                                <label class="form-check-label" for="sms-enabled">
                                    SMS Alerts
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email-enabled">
                                <label class="form-check-label" for="email-enabled">
                                    Email Alerts
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Save Button -->
                <div class="text-end">
                    <button type="button" class="btn btn-skyguard" onclick="saveConfiguration()">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Camera Section -->
<div id="camera-section" class="section" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-video"></i> Camera Management
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Camera Status</h6>
                    <div id="camera-info">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Camera Test</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-skyguard" onclick="testCamera()">
                            <i class="fas fa-video"></i> Test Camera Connection
                        </button>
                        <button class="btn btn-outline-primary" onclick="captureTestImage()">
                            <i class="fas fa-camera"></i> Capture Test Image
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Section -->
<div id="ai-section" class="section" style="display: none;">
    <div class="row">
        <!-- Detection Model -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-brain"></i> Detection Model
                    </h5>
                </div>
                <div class="card-body">
                    <div id="detection-model-info">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Species Classification Model -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-feather-alt"></i> Species Classification Model
                    </h5>
                </div>
                <div class="card-body">
                    <div id="species-model-info">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detection Statistics -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Detection Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div id="detection-stats">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Species Statistics -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Species Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div id="species-stats">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Model Actions -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-cogs"></i> Model Actions
            </h5>
        </div>
        <div class="card-body">
            <div class="d-grid gap-2 d-md-flex">
                <button class="btn btn-skyguard" onclick="testAI()">
                    <i class="fas fa-brain"></i> Test AI Model
                </button>
                <button class="btn btn-outline-primary" onclick="refreshAIStats()">
                    <i class="fas fa-sync"></i> Refresh Stats
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Section -->
<div id="alerts-section" class="section" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-bell"></i> Alert System Management
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Alert Status</h6>
                    <div id="alerts-info">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Alert Testing</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-skyguard" onclick="testAlerts()">
                            <i class="fas fa-bell"></i> Test Alert System
                        </button>
                        <button class="btn btn-outline-primary" onclick="configureAlerts()">
                            <i class="fas fa-cog"></i> Configure Alerts
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logs Section -->
<div id="logs-section" class="section" style="display: none;">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-file-alt"></i> System Logs
            </h5>
            <div>
                <button class="btn btn-sm btn-outline-secondary" id="logs-pause-btn" onclick="toggleLogsPause()">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearLogsDisplay()">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="logs-content" style="max-height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9em; background-color: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 4px;">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Section -->
<div id="stats-section" class="section" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-bar"></i> System Statistics
            </h5>
        </div>
        <div class="card-body">
            <div id="stats-content">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function formatUptime(totalSeconds) {
        const s = Math.max(0, Math.floor(Number(totalSeconds) || 0));
        const secs = s % 60;
        const minsTotal = Math.floor(s / 60);
        const mins = minsTotal % 60;
        const hoursTotal = Math.floor(minsTotal / 60);
        const hours = hoursTotal % 24;
        const daysTotal = Math.floor(hoursTotal / 24);
        const weeks = Math.floor(daysTotal / 7) % 4;
        const days = daysTotal % 7;
        const months = Math.floor(daysTotal / 30.44);
        const parts = [];
        if (months) parts.push(`${months} mo`);
        if (weeks) parts.push(`${weeks} wk`);
        if (days) parts.push(`${days} d`);
        if (hours) parts.push(`${hours} h`);
        if (mins) parts.push(`${mins} m`);
        parts.push(`${secs} s`);
        return parts.join(' ');
    }
    // Robust timestamp formatter that accepts seconds or milliseconds
    function formatTimestamp(ts) {
        const num = Number(ts);
        if (!isFinite(num) || num <= 0) {
            return 'Unknown';
        }
        // Heuristic: values > 1e12 are already in ms, else seconds -> ms
        const ms = num > 1e12 ? num : num * 1000;
        const d = new Date(ms);
        if (isNaN(d.getTime())) {
            return 'Unknown';
        }
        return d.toLocaleString();
    }

    // Format confidence as percentage
    function formatConfidence(confidence) {
        const num = Number(confidence);
        if (!isFinite(num) || num < 0 || num > 1) {
            return 'Unknown';
        }
        return `${(num * 100).toFixed(1)}%`;
    }

    // Load dashboard data
    async function loadDashboardData() {
        try {
            // Load system status
            const statusResponse = await fetch('/api/status');
            const status = await statusResponse.json();
            
            // Update system information (statistics cards removed)
            document.getElementById('system-uptime').textContent = formatUptime(status.system.uptime);
            document.getElementById('last-detection').textContent = 
                status.system.last_detection ? formatTimestamp(status.system.last_detection.timestamp) : 'None';
            document.getElementById('ai-confidence').textContent = 
                formatConfidence(status.ai.confidence_threshold);
            
            // Load recent detections
            await loadRecentDetections();
            
            // Load detection chart
            await loadDetectionChart();
            
        } catch (error) {
            console.error('Failed to load dashboard data:', error);
        }
    }
    
    // Load recent detections
    async function loadRecentDetections() {
        try {
            const response = await fetch('/api/detections?limit=5');
            const data = await response.json();
            const detections = (data && Array.isArray(data.detections)) ? data.detections : [];
            
            const container = document.getElementById('recent-detections');
            if (detections.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No recent detections</div>';
                return;
            }
            
            let html = '';
            detections.forEach(detection => {
                try {
                    html += `
                        <div class="card detection-card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6 class="card-title">
                                            <i class="fas fa-eye"></i> Detection #${detection.id || 'Unknown'}
                                        </h6>
                                        <p class="card-text">
                                            <strong>Class:</strong> ${detection.class || 'bird'}<br>
                                            <strong>Confidence:</strong> ${formatConfidence(detection.confidence)}<br>
                                            <strong>Time:</strong> ${formatTimestamp(detection.timestamp)}
                                        </p>
                                    </div>
                                    <div class="col-md-4">
                                        <img src="/api/detections/${detection.id}/image" 
                                             class="detection-image" 
                                             alt="Detection image"
                                             onerror="this.style.display='none'">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error rendering detection:', error, detection);
                }
            });
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Failed to load recent detections:', error);
        }
    }
    
    // Load detection chart
    async function loadDetectionChart() {
        try {
            const ctx = document.getElementById('detection-chart').getContext('2d');
            
            // This would load actual chart data
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Birds', 'Other'],
                    datasets: [{
                        data: [85, 15],
                        backgroundColor: ['#3498db', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
        } catch (error) {
            console.error('Failed to load detection chart:', error);
        }
    }
    
    // Load detections
    async function loadDetections() {
        try {
            const response = await fetch('/api/detections?limit=50');
            const data = await response.json();
            const detections = (data && Array.isArray(data.detections)) ? data.detections : [];
            
            const container = document.getElementById('detections-list');
            if (detections.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No detections found</div>';
                return;
            }
            
            let html = '';
            detections.forEach(detection => {
                html += `
                    <div class="card detection-card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        <i class="fas fa-eye"></i> Detection #${detection.id}
                                    </h6>
                                    <p class="card-text">
                                        <strong>Class:</strong> ${detection.class || 'bird'}<br>
                                        <strong>Confidence:</strong> ${formatConfidence(detection.confidence)}<br>
                                        <strong>Time:</strong> ${formatTimestamp(detection.timestamp)}
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <img src="/api/detections/${detection.id}/image" 
                                         class="detection-image" 
                                         alt="Detection image"
                                         onerror="this.style.display='none'">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Failed to load detections:', error);
        }
    }
    
    // Load configuration
    async function loadConfiguration() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();
            
            // Populate form fields
            document.getElementById('detection-interval').value = config.system.detection_interval;
            document.getElementById('max-history').value = config.system.max_detection_history;
            document.getElementById('camera-source').value = config.camera.source || 0;
            document.getElementById('camera-width').value = config.camera.width;
            document.getElementById('camera-height').value = config.camera.height;
            document.getElementById('camera-fps').value = config.camera.fps;
            document.getElementById('camera-rotation').value = config.camera.rotation || 0;
            document.getElementById('camera-flip-horizontal').checked = config.camera.flip_horizontal || false;
            document.getElementById('camera-flip-vertical').checked = config.camera.flip_vertical || false;
            document.getElementById('camera-brightness').value = config.camera.brightness || 0;
            document.getElementById('camera-contrast').value = config.camera.contrast || 0;
            document.getElementById('camera-live-view').checked = config.camera.live_view || false;
            document.getElementById('confidence-threshold').value = config.ai.confidence_threshold;
            document.getElementById('nms-threshold').value = config.ai.nms_threshold;
            document.getElementById('detection-log-level').value = config.ai.detection_log_level || 'standard';
            document.getElementById('audio-enabled').checked = config.notifications.audio.enabled;
            document.getElementById('sms-enabled').checked = config.notifications.sms.enabled;
            document.getElementById('email-enabled').checked = config.notifications.email.enabled;
            
            // Update range value displays
            updateRangeValue('confidence-threshold', 'confidence-value');
            updateRangeValue('nms-threshold', 'nms-value');
            
        } catch (error) {
            console.error('Failed to load configuration:', error);
        }
    }
    
    // Update range value display
    function updateRangeValue(rangeId, valueId) {
        const range = document.getElementById(rangeId);
        const value = document.getElementById(valueId);
        range.addEventListener('input', function() {
            value.textContent = this.value;
        });
    }
    
    // Save configuration
    async function saveConfiguration() {
        try {
            const config = {
                system: {
                    detection_interval: parseFloat(document.getElementById('detection-interval').value),
                    max_detection_history: parseInt(document.getElementById('max-history').value)
                },
                camera: {
                    source: parseInt(document.getElementById('camera-source').value),
                    width: parseInt(document.getElementById('camera-width').value),
                    height: parseInt(document.getElementById('camera-height').value),
                    fps: parseInt(document.getElementById('camera-fps').value),
                    rotation: parseInt(document.getElementById('camera-rotation').value),
                    flip_horizontal: document.getElementById('camera-flip-horizontal').checked,
                    flip_vertical: document.getElementById('camera-flip-vertical').checked,
                    brightness: parseInt(document.getElementById('camera-brightness').value),
                    contrast: parseInt(document.getElementById('camera-contrast').value),
                    live_view: document.getElementById('camera-live-view').checked
                },
                ai: {
                    confidence_threshold: parseFloat(document.getElementById('confidence-threshold').value),
                    nms_threshold: parseFloat(document.getElementById('nms-threshold').value),
                    detection_log_level: document.getElementById('detection-log-level').value
                },
                notifications: {
                    audio: {
                        enabled: document.getElementById('audio-enabled').checked
                    },
                    sms: {
                        enabled: document.getElementById('sms-enabled').checked
                    },
                    email: {
                        enabled: document.getElementById('email-enabled').checked
                    }
                }
            };
            
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert('Configuration saved successfully!');
            } else {
                alert('Failed to save configuration: ' + result.error);
            }
            
        } catch (error) {
            alert('Failed to save configuration: ' + error.message);
        }
    }
    
    // Test camera
    async function testCamera() {
        try {
            const response = await fetch('/api/camera/test');
            const result = await response.json();
            
            if (response.ok) {
                alert('Camera test successful!');
            } else {
                alert('Camera test failed: ' + result.error);
            }
        } catch (error) {
            alert('Camera test failed: ' + error.message);
        }
    }
    
    // Test AI
    async function testAI() {
        try {
            const response = await fetch('/api/ai/test');
            const result = await response.json();
            
            if (response.ok) {
                alert('AI model test successful!');
            } else {
                alert('AI model test failed: ' + result.error);
            }
        } catch (error) {
            alert('AI model test failed: ' + error.message);
        }
    }
    
    // Test alerts
    async function testAlerts() {
        try {
            const response = await fetch('/api/alerts/test');
            const result = await response.json();
            
            if (response.ok) {
                alert('Alert system test successful!');
            } else {
                alert('Alert system test failed: ' + result.error);
            }
        } catch (error) {
            alert('Alert system test failed: ' + error.message);
        }
    }
    
    // Load section data functions
    async function loadCameraStatus() {
        // Implementation for camera status
        document.getElementById('camera-info').innerHTML = '<div class="text-muted">Camera status loading...</div>';
    }
    
    async function loadAIStatus() {
        await loadAIStats();
    }
    
    async function loadAIStats() {
        try {
            const response = await fetch('/api/ai/stats');
            const data = await response.json();
            
            if (data.error) {
                console.error('Failed to load AI stats:', data.error);
                return;
            }
            
            // Display detection model info
            const detectionModelDiv = document.getElementById('detection-model-info');
            if (detectionModelDiv) {
                const model = data.model || {};
                const statusBadge = model.model_loaded 
                    ? '<span class="badge bg-success">Loaded</span>' 
                    : '<span class="badge bg-danger">Not Loaded</span>';
                
                detectionModelDiv.innerHTML = `
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>${statusBadge}</td>
                        </tr>
                        <tr>
                            <td><strong>Model Path:</strong></td>
                            <td><code>${model.model_path || 'N/A'}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Model Type:</strong></td>
                            <td>${model.model_type || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Input Size:</strong></td>
                            <td>${model.input_size || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Confidence Threshold:</strong></td>
                            <td>${(model.confidence_threshold || 0).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>NMS Threshold:</strong></td>
                            <td>${(model.nms_threshold || 0).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Log Level:</strong></td>
                            <td><span class="badge bg-info">${model.detection_log_level || 'standard'}</span></td>
                        </tr>
                    </table>
                `;
            }
            
            // Display species model info
            const speciesModelDiv = document.getElementById('species-model-info');
            if (speciesModelDiv) {
                const speciesModel = data.species_model || {};
                const enabledBadge = speciesModel.enabled 
                    ? '<span class="badge bg-success">Enabled</span>' 
                    : '<span class="badge bg-secondary">Disabled</span>';
                
                speciesModelDiv.innerHTML = `
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>${enabledBadge}</td>
                        </tr>
                        <tr>
                            <td><strong>Model Path:</strong></td>
                            <td><code>${speciesModel.model_path || 'N/A'}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Backend:</strong></td>
                            <td>${speciesModel.backend || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Input Size:</strong></td>
                            <td>${Array.isArray(speciesModel.input_size) ? speciesModel.input_size.join('x') : 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Confidence Threshold:</strong></td>
                            <td>${(speciesModel.confidence_threshold || 0).toFixed(2)}</td>
                        </tr>
                    </table>
                `;
            }
            
            // Display detection statistics
            const detectionStatsDiv = document.getElementById('detection-stats');
            if (detectionStatsDiv) {
                const detectorStats = data.detector_stats || {};
                const detectionStats = data.detection_stats || {};
                const confidenceStats = data.confidence_stats || {};
                
                let statsHtml = '<table class="table table-sm">';
                
                if (detectorStats.total_detections !== undefined) {
                    statsHtml += `<tr><td><strong>Session Detections:</strong></td><td>${detectorStats.total_detections || 0}</td></tr>`;
                }
                
                if (detectionStats.total_detections !== undefined) {
                    statsHtml += `<tr><td><strong>Last 7 Days:</strong></td><td>${detectionStats.total_detections || 0}</td></tr>`;
                }
                
                if (detectorStats.last_detection_time) {
                    const lastDetTime = new Date(detectorStats.last_detection_time * 1000);
                    statsHtml += `<tr><td><strong>Last Detection:</strong></td><td>${formatTimestamp(detectorStats.last_detection_time)}</td></tr>`;
                }
                
                if (confidenceStats.count > 0) {
                    statsHtml += `<tr><td><strong>Avg Confidence:</strong></td><td>${(confidenceStats.avg * 100).toFixed(1)}%</td></tr>`;
                    statsHtml += `<tr><td><strong>Min Confidence:</strong></td><td>${(confidenceStats.min * 100).toFixed(1)}%</td></tr>`;
                    statsHtml += `<tr><td><strong>Max Confidence:</strong></td><td>${(confidenceStats.max * 100).toFixed(1)}%</td></tr>`;
                    statsHtml += `<tr><td><strong>Recent Samples:</strong></td><td>${confidenceStats.count}</td></tr>`;
                }
                
                statsHtml += '</table>';
                detectionStatsDiv.innerHTML = statsHtml;
            }
            
            // Display species statistics
            const speciesStatsDiv = document.getElementById('species-stats');
            if (speciesStatsDiv) {
                const speciesStats = data.species_stats || {};
                const breakdown = speciesStats.species_breakdown || {};
                
                let statsHtml = '<table class="table table-sm">';
                statsHtml += `<tr><td><strong>Total Classifications:</strong></td><td>${speciesStats.total_classifications || 0}</td></tr>`;
                statsHtml += `<tr><td><strong>Successful IDs:</strong></td><td>${speciesStats.successful_identifications || 0}</td></tr>`;
                
                if (Object.keys(breakdown).length > 0) {
                    statsHtml += '<tr><td colspan="2"><strong>Species Breakdown:</strong></td></tr>';
                    const sortedSpecies = Object.entries(breakdown).sort((a, b) => b[1].count - a[1].count);
                    sortedSpecies.slice(0, 5).forEach(([species, stats]) => {
                        statsHtml += `<tr><td style="padding-left: 20px;">${species}</td><td>${stats.count} (avg: ${(stats.avg_confidence * 100).toFixed(1)}%)</td></tr>`;
                    });
                }
                
                statsHtml += '</table>';
                speciesStatsDiv.innerHTML = statsHtml;
            }
            
        } catch (error) {
            console.error('Failed to load AI stats:', error);
        }
    }
    
    function refreshAIStats() {
        loadAIStats();
    }
    
    async function loadAlertsStatus() {
        // Implementation for alerts status
        document.getElementById('alerts-info').innerHTML = '<div class="text-muted">Alerts status loading...</div>';
    }
    
    // Logs tailing state
    let logsLastTimestamp = null;
    let logsPaused = false;
    let logsInterval = null;
    let logsContainer = null;
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatLogMessage(message) {
        // First escape HTML to prevent XSS
        let escaped = escapeHtml(message);
        let formatted = escaped;
        
        // Detection logs
        if (escaped.includes('[DETECT]')) {
            formatted = formatted.replace(
                /üê¶ \[DETECT\] (.*)/g,
                '<span style="color: #4ec9b0;">üê¶ [DETECT]</span> <span style="color: #ce9178;">$1</span>'
            );
        }
        
        // Segmentation logs
        if (escaped.includes('[SEG]')) {
            formatted = formatted.replace(
                /üîç \[SEG\] (.*)/g,
                '<span style="color: #569cd6;">üîç [SEG]</span> <span style="color: #ce9178;">$1</span>'
            );
        }
        
        // Species classification logs
        if (escaped.includes('[SPECIES]')) {
            if (escaped.includes('‚úÖ')) {
                formatted = formatted.replace(
                    /‚úÖ \[SPECIES\] (.*)/g,
                    '<span style="color: #4ec9b0;">‚úÖ [SPECIES]</span> <span style="color: #ce9178;">$1</span>'
                );
            } else if (escaped.includes('‚ùå')) {
                formatted = formatted.replace(
                    /‚ùå \[SPECIES\] (.*)/g,
                    '<span style="color: #f48771;">‚ùå [SPECIES]</span> <span style="color: #ce9178;">$1</span>'
                );
            } else if (escaped.includes('üî¨')) {
                formatted = formatted.replace(
                    /üî¨ \[SPECIES\] (.*)/g,
                    '<span style="color: #dcdcaa;">üî¨ [SPECIES]</span> <span style="color: #ce9178;">$1</span>'
                );
            } else if (escaped.includes('üìä')) {
                formatted = formatted.replace(
                    /üìä \[SPECIES\] (.*)/g,
                    '<span style="color: #9cdcfe;">üìä [SPECIES]</span> <span style="color: #ce9178;">$1</span>'
                );
            }
        }
        
        // Highlight key-value pairs (after escaping)
        formatted = formatted.replace(
            /(\w+)=([0-9.]+|\[[^\]]+\])/g,
            '<span style="color: #9cdcfe;">$1</span>=<span style="color: #ce9178;">$2</span>'
        );
        
        return formatted;
    }
    
    function getLogLevelColor(level) {
        const colors = {
            'DEBUG': '#808080',
            'INFO': '#4ec9b0',
            'WARNING': '#dcdcaa',
            'ERROR': '#f48771',
            'CRITICAL': '#f48771'
        };
        return colors[level] || '#d4d4d4';
    }
    
    async function loadLogs(append = false) {
        if (logsPaused) return;
        
        try {
            const url = logsLastTimestamp && append
                ? `/api/logs?limit=500&since=${logsLastTimestamp}`
                : '/api/logs?limit=500';
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.error) {
                console.error('Failed to load logs:', data.error);
                return;
            }
            
            const logs = data.logs || [];
            const container = document.getElementById('logs-content');
            logsContainer = container;
            
            if (logs.length === 0 && !append) {
                container.innerHTML = '<div class="text-center text-muted">No logs available</div>';
                return;
            }
            
            // If appending, add to existing content, otherwise replace
            let html = append ? container.innerHTML : '';
            
            logs.forEach(log => {
                const timeStr = log.timestamp_str || formatTimestamp(log.timestamp);
                const levelColor = getLogLevelColor(log.level);
                const formattedMessage = formatLogMessage(log.message || log.raw);
                
                html += `<div style="margin-bottom: 2px; padding: 2px 0; border-bottom: 1px solid #2d2d2d;">
                    <span style="color: #808080; margin-right: 10px;">${timeStr}</span>
                    <span style="color: ${levelColor}; margin-right: 10px; font-weight: bold; min-width: 60px; display: inline-block;">${log.level}</span>
                    <span style="color: #808080; margin-right: 10px;">${log.module}</span>
                    <span>${formattedMessage}</span>
                </div>`;
            });
            
            container.innerHTML = html;
            
            // Update last timestamp
            if (data.last_timestamp) {
                logsLastTimestamp = data.last_timestamp;
            }
            
            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
            
        } catch (error) {
            console.error('Failed to load logs:', error);
        }
    }
    
    function toggleLogsPause() {
        logsPaused = !logsPaused;
        const btn = document.getElementById('logs-pause-btn');
        if (logsPaused) {
            btn.innerHTML = '<i class="fas fa-play"></i> Resume';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-success');
        } else {
            btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-outline-secondary');
            // Immediately load logs when resuming
            loadLogs(true);
        }
    }
    
    function clearLogsDisplay() {
        const container = document.getElementById('logs-content');
        container.innerHTML = '';
        logsLastTimestamp = null;
        loadLogs(false);
    }
    
    function startLogsTailing() {
        // Clear any existing interval
        if (logsInterval) {
            clearInterval(logsInterval);
        }
        
        // Load initial logs
        loadLogs(false);
        
        // Set up auto-refresh every 2 seconds
        logsInterval = setInterval(() => {
            loadLogs(true);
        }, 2000);
    }
    
    function stopLogsTailing() {
        if (logsInterval) {
            clearInterval(logsInterval);
            logsInterval = null;
        }
    }
    
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const stats = await response.json();
            
            const container = document.getElementById('stats-content');
            let html = '<div class="row">';
            html += `<div class="col-md-6"><h6>System Resources</h6><p>CPU: ${stats.cpu_percent}%<br>Memory: ${stats.memory_percent}%<br>Disk: ${stats.disk_percent}%</p></div>`;
            html += `<div class="col-md-6"><h6>Detection Statistics</h6><p>Today: ${stats.detections_today}<br>This Week: ${stats.detections_this_week}<br>This Month: ${stats.detections_this_month}</p></div>`;
            html += '</div>';
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }
    
    // Recent Captures Functions
    let recentCaptureInterval = null;
    
    async function loadRecentCaptures() {
        // Load recent capture status and display
        try {
            const response = await fetch('/api/camera/status');
            const status = await response.json();
            
            // Update capture timestamp only (status pill removed)
            const timestampElement = document.getElementById('capture-timestamp');
            
            // Initialize timestamp
            if (timestampElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                const dateString = now.toLocaleDateString();
                timestampElement.textContent = `Last updated: ${dateString} ${timeString}`;
            }
            
            // Start automatic refresh every 3 seconds
            startAutoRefresh();
            
        } catch (error) {
            console.error('Failed to load capture status:', error);
        }
    }
    
    function startAutoRefresh() {
        // Clear any existing interval
        if (recentCaptureInterval) {
            clearInterval(recentCaptureInterval);
        }
        
        // Set up automatic refresh every 3 seconds
        recentCaptureInterval = setInterval(() => {
            refreshRecentCapture();
        }, 3000);
        
        // Initial load
        refreshRecentCapture();
    }
    
    function stopAutoRefresh() {
        if (recentCaptureInterval) {
            clearInterval(recentCaptureInterval);
            recentCaptureInterval = null;
        }
    }
    
    function refreshRecentCapture() {
        const captureImg = document.getElementById('recent-capture-image');
        const timestampElement = document.getElementById('capture-timestamp');
        
        if (captureImg) {
            // Add timestamp to prevent caching
            const timestamp = new Date().getTime();
            captureImg.src = `/api/camera/feed?t=${timestamp}`;
            
            // Update timestamp display
            if (timestampElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                const dateString = now.toLocaleDateString();
                timestampElement.textContent = `Last updated: ${dateString} ${timeString}`;
            }
        }
    }
    
    function downloadRecentCapture() {
        try {
            const link = document.createElement('a');
            link.href = '/api/camera/capture';
            link.download = 'skyguard_recent_capture_' + new Date().getTime() + '.jpg';
            link.click();
        } catch (error) {
            console.error('Failed to download recent capture:', error);
            alert('Failed to download recent capture');
        }
    }
    
    // Update range value displays
    function updateRangeValue(inputId, valueId) {
        const input = document.getElementById(inputId);
        const value = document.getElementById(valueId);
        if (input && value) {
            value.textContent = input.value;
            input.addEventListener('input', function() {
                value.textContent = this.value;
            });
        }
    }
    
    // Update configuration in real-time
    async function update_config() {
        try {
            // Helper function to safely get element values
            function getValue(id, defaultValue = 0) {
                const element = document.getElementById(id);
                if (!element) return defaultValue;
                if (element.type === 'checkbox') return element.checked;
                if (element.type === 'number' || element.type === 'range') return parseFloat(element.value) || defaultValue;
                return element.value || defaultValue;
            }
            
            const config = {
                system: {
                    detection_interval: getValue('detection-interval', 1.0),
                    max_detection_history: getValue('max-history', 1000)
                },
                camera: {
                    source: getValue('camera-source', 0),
                    width: getValue('camera-width', 1920),
                    height: getValue('camera-height', 1080),
                    fps: getValue('camera-fps', 30),
                    rotation: getValue('camera-rotation', 0),
                    flip_horizontal: getValue('camera-flip-horizontal', false),
                    flip_vertical: getValue('camera-flip-vertical', false),
                    brightness: getValue('camera-brightness', 0),
                    contrast: getValue('camera-contrast', 0),
                    live_view: getValue('camera-live-view', false)
                },
                ai: {
                    confidence_threshold: getValue('confidence-threshold', 0.3),
                    nms_threshold: getValue('nms-threshold', 0.4),
                    detection_log_level: getValue('detection-log-level', 'standard')
                },
                notifications: {
                    audio: {
                        enabled: getValue('audio-enabled', true)
                    },
                    sms: {
                        enabled: getValue('sms-enabled', false)
                    },
                    email: {
                        enabled: getValue('email-enabled', false)
                    }
                }
            };
            
            // Validate configuration before sending
            if (config.system.detection_interval <= 0 || config.system.max_detection_history <= 0) {
                console.warn('Invalid system configuration, skipping update');
                return;
            }
            
            if (config.camera.width <= 0 || config.camera.height <= 0 || config.camera.fps <= 0) {
                console.warn('Invalid camera configuration, skipping update');
                return;
            }
            
            if (config.ai.confidence_threshold < 0 || config.ai.confidence_threshold > 1) {
                console.warn('Invalid AI configuration, skipping update');
                return;
            }
            
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                console.log('Configuration updated successfully');
                // Optionally show a success message
                if (typeof showNotification === 'function') {
                    showNotification('Configuration updated successfully!', 'success');
                }
            } else {
                console.error('Failed to update configuration:', result.error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to update configuration: ' + result.error, 'error');
                }
            }
        } catch (error) {
            console.error('Failed to update configuration:', error);
            if (typeof showNotification === 'function') {
                showNotification('Failed to update configuration: ' + error.message, 'error');
            }
        }
    }
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        
        // Initialize range value displays
        updateRangeValue('confidence-threshold', 'confidence-value');
        updateRangeValue('nms-threshold', 'nms-value');
        updateRangeValue('camera-brightness', 'brightness-value');
        updateRangeValue('camera-contrast', 'contrast-value');
        updateRangeValue('live-brightness', 'live-brightness-value');
        updateRangeValue('live-contrast', 'live-contrast-value');
        
        // Add event listeners for real-time configuration updates
        const configInputs = [
            'detection-interval', 'max-history', 'camera-source', 'camera-width', 
            'camera-height', 'camera-fps', 'camera-rotation', 'camera-flip-horizontal',
            'camera-flip-vertical', 'camera-brightness', 'camera-contrast', 
            'camera-live-view', 'confidence-threshold', 'nms-threshold', 'detection-log-level',
            'audio-enabled', 'sms-enabled', 'email-enabled'
        ];
        
        configInputs.forEach(inputId => {
            const element = document.getElementById(inputId);
            if (element) {
                element.addEventListener('change', update_config);
                element.addEventListener('input', update_config);
            }
        });
    });
</script>
{% endblock %}
